<!DOCTYPE html>
<html>
<head>
    <title>Day 99 - Data Warehouse OLAP</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .olap-card { border-left: 4px solid #007bff; margin-bottom: 20px; }
        .operation-btn { margin: 5px; }
        .result-table { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">üèóÔ∏è Day 99 - Data Warehouse & OLAP Systems</h1>
            </div>
        </div>

        <!-- Schema Information -->
        <div class="row">
            <div class="col-md-6">
                <div class="card olap-card">
                    <div class="card-header">
                        <h5>üìä Data Warehouse Schema</h5>
                    </div>
                    <div class="card-body">
                        <div id="schemaInfo">
                            <p>Loading schema information...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card olap-card">
                    <div class="card-header">
                        <h5>üéØ OLAP Operations</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary operation-btn" onclick="performOLAP('roll_up')">
                            üîù Roll-up
                        </button>
                        <button class="btn btn-success operation-btn" onclick="performOLAP('drill_down')">
                            üîç Drill-down
                        </button>
                        <button class="btn btn-warning operation-btn" onclick="performOLAP('slice')">
                            üî™ Slice
                        </button>
                        <button class="btn btn-info operation-btn" onclick="performOLAP('dice')">
                            üé≤ Dice
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìà OLAP Operation Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="operationResult" class="result-table">
                            <p>Select an OLAP operation to see results...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Charts -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìà Sales Trend</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="salesChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üèÜ Top Products</h5>
                    </div>
                    <div class="card-body">
                        <div id="productTable" class="result-table"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- OLAP Definitions -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìö OLAP Operations Explained</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <h6>Roll-up</h6>
                                <p>Summarize data to higher level of abstraction</p>
                            </div>
                            <div class="col-md-3">
                                <h6>Drill-down</h6>
                                <p>Navigate from summary to detailed data</p>
                            </div>
                            <div class="col-md-3">
                                <h6>Slice</h6>
                                <p>Select specific dimension value</p>
                            </div>
                            <div class="col-md-3">
                                <h6>Dice</h6>
                                <p>Select specific cells from multiple dimensions</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load schema information
        fetch('/schema_info')
            .then(response => response.json())
            .then(data => {
                const schemaDiv = document.getElementById('schemaInfo');
                schemaDiv.innerHTML = `
                    <p><strong>Fact Tables:</strong> ${data.fact_tables.join(', ')}</p>
                    <p><strong>Dimension Tables:</strong> ${data.dimension_tables.join(', ')}</p>
                    <p><strong>Measures:</strong> ${data.measures.join(', ')}</p>
                    <p><strong>Dimensions:</strong> ${data.dimensions.join(', ')}</p>
                `;
            });

        // Perform OLAP operations
        function performOLAP(operation) {
            document.getElementById('operationResult').innerHTML = '<p>Processing...</p>';
            
            fetch('/olap_operation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({operation: operation})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data.operation, data.data);
                } else {
                    document.getElementById('operationResult').innerHTML = `<p class="text-danger">Error: ${data.error}</p>`;
                }
            });
        }

        // Display results
        function displayResults(operation, data) {
            let html = `<h6>Operation: ${operation}</h6>`;
            
            if (data.length > 0 && typeof data[0] === 'object' && 'measure' in data[0]) {
                // Single value results
                html += '<table class="table table-striped"><thead><tr><th>Measure</th><th>Value</th></tr></thead><tbody>';
                data.forEach(item => {
                    html += `<tr><td>${item.measure}</td><td>${item.value}</td></tr>`;
                });
                html += '</tbody></table>';
            } else {
                // Tabular results
                html += '<table class="table table-striped"><thead><tr>';
                Object.keys(data[0]).forEach(key => {
                    html += `<th>${key}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.forEach(row => {
                    html += '<tr>';
                    Object.values(row).forEach(value => {
                        html += `<td>${value}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
            }
            
            document.getElementById('operationResult').innerHTML = html;
        }

        // Load analysis data
        fetch('/get_analysis')
            .then(response => response.json())
            .then(data => {
                // Sales chart
                const salesCtx = document.getElementById('salesChart').getContext('2d');
                const salesData = data.sales_trend;
                
                new Chart(salesCtx, {
                    type: 'line',
                    data: {
                        labels: salesData.map(item => item.period),
                        datasets: [{
                            label: 'Sales Amount',
                            data: salesData.map(item => item.total_amount),
                            borderColor: '#007bff',
                            tension: 0.1
                        }]
                    }
                });

                // Product table
                const productTable = document.getElementById('productTable');
                let productHtml = '<table class="table table-sm"><thead><tr><th>Product</th><th>Revenue</th></tr></thead><tbody>';
                
                data.product_performance.forEach(product => {
                    productHtml += `<tr><td>${product.Product}</td><td>$${product['Total Revenue']}</td></tr>`;
                });
                
                productHtml += '</tbody></table>';
                productTable.innerHTML = productHtml;
            });
    </script>
</body>
</html>